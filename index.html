<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medication Tracker App</title>
  <!-- Include React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Include Babel for JSX transformation -->
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const MedicationTracker = () => {
      // State for current time to force timer updates
      const [currentTime, setCurrentTime] = React.useState(new Date().getTime());
      
      // State for medications - reset on every page load for mockup purposes
      const [medications, setMedications] = React.useState([
        { id: 1, name: '', schedule: '', timerHours: null, timerActive: false, completed: false, photoTaken: false, selfieImage: null }
      ]);
      
      // State for countdown timers
      const [timers, setTimers] = React.useState({});
      
      // State for camera
      const [cameraActive, setCameraActive] = React.useState(false);
      const [currentMedicationId, setCurrentMedicationId] = React.useState(null);
      const [showMenu, setShowMenu] = React.useState(false);
      const menuRef = React.useRef(null);
      const videoRef = React.useRef(null);
      const canvasRef = React.useRef(null);
      
      // Update timer display every 100ms
      React.useEffect(() => {
        console.log("Setting up timer interval");
        const interval = setInterval(() => {
          const now = new Date().getTime();
          setCurrentTime(now);
          // Update timers
          Object.keys(timers).forEach(id => {
            const targetTime = timers[id];
            if (targetTime && targetTime <= now) {
              console.log(`Timer expired for medication ${id}`);
              
              // Update timers state
              setTimers(prev => {
                const newTimers = {...prev};
                delete newTimers[id];
                return newTimers;
              });
              
              // Reset medication status
              setMedications(prevMeds => 
                prevMeds.map(med => 
                  med.id.toString() === id 
                    ? {...med, completed: false, photoTaken: false, timerActive: false} 
                    : med
                )
              );
            }
          });
        }, 100);
        
        return () => clearInterval(interval);
      }, []);
      
      // Format milliseconds as HH:MM:SS for display
      const formatTime = (ms) => {
        if (!ms) return "--:--:--";
        
        const now = new Date().getTime();
        const diff = Math.max(0, ms - now);
        
        if (diff <= 0) return "TAKE NOW";
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      };
      
      // Set timer value for medication (but don't start it yet)
      const setMedicationTimer = (id, hours) => {
        if (!hours || isNaN(hours)) return;
        console.log(`Setting timer hours for medication ${id}: ${hours} hours`);
        
        // Convert hours to a number
        const hoursNum = parseFloat(hours);
        
        setMedications(prev => 
          prev.map(med => 
            med.id === id 
              ? {
                  ...med, 
                  schedule: `Every ${hoursNum} hours`,
                  timerHours: hoursNum
                } 
              : med
          )
        );
      };
      
      // Start timer for a medication
      const startTimer = (medicationId) => {
        // Find the medication
        const medication = medications.find(m => m.id === medicationId);
        if (!medication || !medication.timerHours) {
          console.warn(`No timer hours set for medication ${medicationId}`);
          return;
        }
        
        // Calculate target time
        const hoursInMs = medication.timerHours * 60 * 60 * 1000;
        const targetTime = new Date().getTime() + hoursInMs;
        
        console.log(`Starting timer for medication ${medicationId}. Target time: ${new Date(targetTime).toLocaleTimeString()}`);
        
        // Update timers
        setTimers(prev => ({
          ...prev,
          [medicationId]: targetTime
        }));
        
        // Mark timer as active
        setMedications(prev => 
          prev.map(med => 
            med.id === medicationId 
              ? { ...med, timerActive: true } 
              : med
          )
        );
      };
      
      // Start camera
      const startCamera = async (medicationId) => {
        try {
          console.log("Starting camera for medication ID:", medicationId);
          setCurrentMedicationId(medicationId);
          setCameraActive(true);
          
          const constraints = {
            video: { 
              width: { ideal: 640 },
              height: { ideal: 480 },
              facingMode: 'user'
            }
          };
          
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          console.log("Camera access granted", stream);
          
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            videoRef.current.onloadedmetadata = () => {
              videoRef.current.play();
              console.log("Video is playing");
            };
          }
        } catch (error) {
          console.error("Camera access error:", error.name, error.message);
          alert(`Camera error: ${error.message}`);
          setCameraActive(false);
        }
      };
      
      // Take a selfie
      const takeSelfie = () => {
        if (!videoRef.current || !canvasRef.current || !currentMedicationId) {
          console.error("Missing refs or medication ID");
          return;
        }
        
        try {
          const video = videoRef.current;
          const canvas = canvasRef.current;
          
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          const context = canvas.getContext('2d');
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          const imageDataURL = canvas.toDataURL('image/png');
          console.log("Photo captured");
          
          // Update medication with selfie
          setMedications(prev => 
            prev.map(med => 
              med.id === currentMedicationId 
                ? {
                    ...med, 
                    completed: true, 
                    photoTaken: true,
                    selfieImage: imageDataURL
                  } 
                : med
            )
          );
          
          // Start timer if set but not active
          const medication = medications.find(m => m.id === currentMedicationId);
          if (medication && medication.timerHours && !medication.timerActive) {
            startTimer(currentMedicationId);
          }
          
          stopCamera();
          
          setTimeout(() => {
            alert(`You've unlocked Candy Crush Level ${currentMedicationId}!`);
          }, 300);
        } catch (error) {
          console.error("Error taking photo:", error);
          alert("Failed to take photo: " + error.message);
        }
      };
      
      // Stop camera
      const stopCamera = () => {
        if (videoRef.current && videoRef.current.srcObject) {
          const tracks = videoRef.current.srcObject.getTracks();
          tracks.forEach(track => track.stop());
          videoRef.current.srcObject = null;
          console.log("Camera stopped");
        }
        setCameraActive(false);
        setCurrentMedicationId(null);
      };
      
      // Add new medication box
      const addMedication = () => {
        const newId = medications.length > 0 
          ? Math.max(...medications.map(m => m.id)) + 1 
          : 1;
          
        setMedications([
          ...medications,
          { id: newId, name: '', schedule: '', timerHours: null, timerActive: false, completed: false, photoTaken: false, selfieImage: null }
        ]);
      };
      React.useEffect(() => {
  const handleClickOutside = (event) => {
    if (menuRef.current && !menuRef.current.contains(event.target)) {
      setShowMenu(false);
    }
  };

  if (showMenu) {
    document.addEventListener("mousedown", handleClickOutside);
  } else {
    document.removeEventListener("mousedown", handleClickOutside);
  }

  return () => {
    document.removeEventListener("mousedown", handleClickOutside);
  };
}, [showMenu]);

      return (
        <div className="bg-sky-200 min-h-screen p-4">
          {/* Logo Space */}
          <div className="h-30 flex items-center justify-center mb-5">
            
  <img 
    src="logo.png" 
    alt="App Logo" 
    className="h-40 w-auto object-contain"
  />
</div>
{/* Top Right Menu Button */}
<div className="absolute top-4 right-4 z-50">
  <div className="relative" ref={menuRef}>
    <button
      onClick={() => setShowMenu(!showMenu)}
      className="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow hover:bg-gray-100"
    >
      <span className="text-2xl">â˜°</span>
    </button>

    {showMenu && (
      <div className="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg py-2">
        <button className="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Raffle</button>
        <button className="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Opt-in for text reminder</button>
        <button className="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Support</button>
      </div>
    )}
  </div>
</div>

          {/* Main App Container */}
          <div className="font-sans max-w-md mx-auto p-5 bg-white rounded-lg shadow">
            <h1 className="text-center py-4 bg-blue-500 text-white rounded-t-lg -mt-5 -mx-5 mb-5">
              Medication Tracker
            </h1>
            
            {/* Camera Modal */}
            {cameraActive && (
              <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-lg max-w-lg w-full">
                  <h2 className="text-2xl font-bold mb-4 text-center">Take Your Medication Selfie</h2>
                  <div className="relative">
                    <video 
                      ref={videoRef} 
                      autoPlay 
                      playsInline 
                      className="w-full h-auto bg-black object-cover rounded"
                      style={{ maxHeight: "60vh" }}
                    ></video>
                    <canvas ref={canvasRef} className="hidden" width="640" height="480"></canvas>
                  </div>
                  <div className="flex justify-center gap-4 mt-4">
                    <button 
                      onClick={takeSelfie} 
                      className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg"
                    >
                      ðŸ“· Take Photo
                    </button>
                    <button 
                      onClick={stopCamera} 
                      className="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg"
                    >
                      Cancel
                    </button>
                  </div>
                  <p className="text-gray-500 text-center mt-4">
                    Make sure you're clearly visible in the camera frame
                  </p>
                </div>
              </div>
            )}
            
            <div className="mt-5">
              {medications.map(medication => (
                <div key={medication.id} className="flex bg-white rounded-lg p-4 mb-4 shadow-sm">
                  {/* Medication Content */}
                  <div className="flex-1 mr-1" style={{ minWidth: "calc(100% - 40px)" }}>
                    {/* Medication Name Input */}
                    <input
                      type="text"
                      placeholder="Medication name (include dosage and time)"
                      value={medication.name}
                      onChange={(e) => {
                        setMedications(medications.map(med => 
                          med.id === medication.id ? {...med, name: e.target.value} : med
                        ));
                      }}
                      className="w-full p-2 border border-gray-300 rounded mb-2"
                    />
                    
                    {/* Timer Setup */}
                    <div className="flex mb-2">
                      <input
                        type="number"
                        min="0.01"
                        step="0.01"
                        placeholder="Hours between doses"
                        className="w-2/3 p-2 border border-gray-300 rounded-l"
                        id={`timer-input-${medication.id}`}
                        defaultValue={medication.timerHours || ""}
                      />
                      <button
                        onClick={() => {
                          const inputElement = document.getElementById(`timer-input-${medication.id}`);
                          const inputValue = inputElement ? inputElement.value : null;
                          
                          if (inputValue && !isNaN(inputValue) && parseFloat(inputValue) > 0) {
                            setMedicationTimer(medication.id, inputValue);
                            // For testing, add a visible notification
                            alert(`Timer value set: ${inputValue} hours. Take a selfie to start the timer.`);
                          } else {
                            alert("Please enter a valid positive number for hours");
                          }
                        }}
                        className="w-1/3 p-2 bg-blue-500 text-white border-none rounded-r cursor-pointer"
                      >
                        Set Timer
                      </button>
                    </div>
                    
                    {/* Debug Timer Info */}
                    <div className="text-xs text-gray-500 mb-1">
                      {medication.timerHours ? 
                        `Timer set: ${medication.timerHours} hours. ${medication.timerActive ? 'Active' : 'Inactive'}` : 
                        'No timer set'}
                    </div>
                    
                    {/* Countdown Display */}
                    <div className="text-center p-2 bg-gray-100 rounded mb-2 font-mono text-lg">
                      {formatTime(timers[medication.id])}
                    </div>
                    
                    {/* Checkbox, Selfie and Game Buttons */}
                    <div className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={medication.completed}
                        readOnly
                        className="w-5 h-5 cursor-default pointer-events-none"
                      />
                      
                      <button
                        onClick={() => startCamera(medication.id)}
                        className="flex items-center bg-blue-500 text-white px-3 py-1 rounded cursor-pointer"
                      >
                        ðŸ“· Take Selfie
                      </button>
                      
                      <button
                        disabled={!medication.completed}
                        onClick={() => {
                          if (medication.completed) {
                            alert(`Starting Candy Crush Level ${medication.id}`);
                          }
                        }}
                        className={`px-8 py-4 rounded-full font-bold uppercase text-xl ${
                          medication.completed 
                            ? "bg-red-500 text-blue-900 border-2 border-blue-900 cursor-pointer" 
                            : "bg-gray-300 text-gray-500 cursor-not-allowed"
                        }`}
                        style={{
                          boxShadow: medication.completed ? '0 5px 0 #1e3a8a' : 'none',
                          minWidth: '140px'
                        }}
                      >
                        Play
                      </button>
                    </div>
                    
                    {/* Selfie Image (if taken) */}
                    {medication.photoTaken && (
                      <div className="mt-2">
                        {medication.selfieImage ? (
                          <img 
                            src={medication.selfieImage} 
                            alt="Selfie" 
                            className="w-16 h-16 object-cover rounded"
                          />
                        ) : (
                          <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-500">
                            ðŸ“· 
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  
                  {/* Caregiver Connect Button */}
                  <button 
                    className="flex flex-col items-center self-center cursor-pointer bg-transparent border-none scale-75"
                    onClick={() => alert(`Connecting with caregiver for medication: ${medication.name || 'Unnamed medication'}`)}
                    style={{ maxWidth: "64px", flexShrink: 0 }}
                  >
                    <div className="w-12 h-12 bg-sky-200 rounded-lg border-2 border-blue-900 flex flex-col items-center justify-center overflow-hidden">
                      {/* Head */}
                      <div className="w-4 h-4 bg-black rounded-full mb-[2px]"></div>
                      {/* Body */}
                      <div className="w-6 h-4 bg-black rounded-t-full mt-[-1px]"></div>
                    </div>
                    <span className="block text-center mt-[3px] text-blue-900 font-bold text-[20px] leading-none">
                      Caregiver Connect
                    </span>
                  </button>
                </div>
              ))}
            </div>
            
            {/* Add Medication Button */}
            <button
              onClick={addMedication}
              className="fixed bottom-5 right-5 w-12 h-12 rounded-full bg-green-500 text-white text-2xl border-none flex items-center justify-center shadow-lg cursor-pointer z-50"
            >
              +
            </button>
          </div>
        </div>
      );
    };

    // Render the component
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MedicationTracker />);
  </script>
</body>
</html>